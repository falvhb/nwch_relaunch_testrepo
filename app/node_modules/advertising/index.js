import _ from 'lodash';
import getPageConfig from './helpers/get-page-config';
import { getAdSlotConfig } from './helpers/responsive-ads';
import { getViewportWidth } from 'helpers';

const ADTECH = window.ADTECH;

let injectedAd;

let testBelowSidebar = () => {
  let sidebar = document.querySelector('.recommendations-top');
  let isBelowSidebar = (injectedAd.offsetTop - sidebar.offsetTop) > (sidebar.clientHeight + 60);
  injectedAd.className = isBelowSidebar && getViewportWidth() > 1150
    ? 'ad is-below-sidebar'
    : 'ad';
};

export default {

  init: function (selector) {
    // load the config for current page from global az object
    var pageAdConfig = _.get(window.az, 'advertising.pageConfig');
    var siteId, pageConfig, ads, keywords;

    // exit if no ad configuration for page is found
    if (!pageAdConfig || !_.isObject(pageAdConfig)) {
      // console.warn('no advertisng configured');
      return;
    }

    if (typeof ADTECH !== 'undefined') {
      // turn on debug mode if needed
      // ADTECH.debugMode = true;

      // get current site id
      siteId = pageAdConfig.siteId;
      // get the ad keywords
      keywords = this.getAdKeywords().join(':');
      // page config
      pageConfig = getPageConfig(siteId, keywords);
      ADTECH.config.page = pageConfig;

      // setup ad slots
      this.setupAds(pageAdConfig.slots);

      // Select all ads on the page
      ads = document.querySelectorAll(selector);

      // Loop them and enqueue
      _.each(pageAdConfig.slots, function(slot) {
        ADTECH.enqueueAd(slot.name);
      });

      // Execute
      ADTECH.executeQueue({
        multiAd: {
          disableAdInjection: true
        }
      });

    } else {
      // Remove all our ad slots
      _.each(ads, function(ad) {
        ad.parentNode.removeChild(ad);
      });

    }

  },

  setupAds: function (adSlots) {
    _.each(adSlots, function (slot) {
      var slotName = slot.name;
      var slotPlacements = slot.placements;
      var slotConfig = getAdSlotConfig(slotPlacements);
      // don't get confused on the naming here, Adtech treats everything as placements
      // while we have slots which can have multiple placements for responsive ads
      ADTECH.config.placements[slotName] = slotConfig;
    });
  },

  getAdKeywords: function () {
    var keywords = [];
    var keywordAttribute = 'data-ad-keywords';
    var keyWordSelector = '[' + keywordAttribute + ']';
    var keywordElements = document.querySelectorAll(keyWordSelector);
    _.each(keywordElements, function (element) {
      var itemKeywords = element.getAttribute(keywordAttribute).split(',');
      // trim whitespace for each keyword
      itemKeywords = _.map(itemKeywords, function (keyword) {
        return keyword.trim().toLowerCase();
      });

      keywords = keywords.concat(itemKeywords);

    });
    keywords = _.unique(keywords);

    return keywords;
  },

  injectAd: function (params) {

    if (document.querySelector(params.content)) {

      let { id, beforeParagraph, content } = params;

      // make the ad
      let ad = document.createElement('div');
      ad.id = id;

      // set  in the upper scope
      injectedAd = ad;

      // query the dom
      let selector = content + ' > p';
      let pElements = document.querySelectorAll(selector);
      let targetP = pElements[beforeParagraph - 1];

      //  inject it
      if (targetP) {
        targetP.parentNode.insertBefore(ad, targetP);
      } else {
        let contentBlocks = document.querySelectorAll(content);
        _.last(contentBlocks).appendChild(ad);
      }

      // see if we are below the sidebar
      testBelowSidebar();
      let debounced = _.debounce(testBelowSidebar, 250);
      window.addEventListener('resize', debounced);
    }

  }

};
