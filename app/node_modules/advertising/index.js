var _ = require('lodash');
var getAccountConfig = require('./helpers/get-account-config');
var getPageSlots = require('./helpers/get-page-slots').getPageSlots;
var getAdSlotConfig = require('./helpers/responsive-ads').getAdSlotConfig;
var getDomainFromSkinName = require('../helpers/get-domain-from-skin');


var ADTECH = window.ADTECH;


var setupAds = function (adSlots) {
  _.each(adSlots, function (slot) {
    var slotName = slot.name;
    var slotPlacements = slot.placements;
    var slotConfig = getAdSlotConfig(slotPlacements);
    // don't get confused on the naming here, Adtech treats everything as placements
    // while we have slots which can have multiple placements for responsive ads
    // console.log('configuring adslot: ', slotName, slotConfig);
    ADTECH.config.placements[slotName] = slotConfig;
  });
};




var Advertising = {
  init: function (selector) {
    // load the config for current page from global az object
    var pageAdConfig = _.get(window.az, 'advertising.pageConfig');
    var siteId;
    var accountConfig;
    var ads;

    // exit if no ad configuration for page is found
    if (!pageAdConfig || !_.isObject(pageAdConfig)) {
      // console.warn('no advertisng configured');
      return;
    }

    // get current site id
    siteId = pageAdConfig.siteId;
    // page account config
    accountConfig = getAccountConfig(siteId);


    // Select all ads on the page
    ads = document.querySelectorAll(selector);

    if (typeof ADTECH !== 'undefined') {
      ADTECH.debugMode = true;
      // Configure our account
      ADTECH.config.page = accountConfig;

      // setup ad slots
      setupAds(pageAdConfig.slots);

      // Loop them and enqueue
      _.each(ads, function(ad) {
        ADTECH.enqueueAd(ad.getAttribute('id'));
      });

      // Execute
      ADTECH.executeQueue({
        multiAd: {
          disableAdInjection: true
        }
      });

    } else {
      // Remove all our ad slots
      _.each(ads, function(ad) {
        ad.parentNode.removeChild(ad);
      });

    }

};

module.exports = Advertising;
