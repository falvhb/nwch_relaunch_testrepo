var adConfig = require('./config/ad-config.json');
var accountConfig = require('./config/account');
var _ = require('lodash');
var ADTECH = window.ADTECH;


var getSiteAdConfig = function (websiteId) {
  return _.where(adConfig, {'website_id': websiteId})[0];
};


// load the config for aargauerzeitung.ch
var websiteId = "1179268";
var demoSiteConfig = getSiteAdConfig(websiteId);
// artikel site id
var articleSiteId = "783730";

var setupAdPlacements = function (siteAdConfig) {
  _.each(siteAdConfig.page_types, function (pageType) {
    _.each(pageType.placements, function (placement) {
      var placementName = placement.name;
      var placementConfig = placement.config;

      ADTECH.config.placements[placementName] = placementConfig;
    });
  });
};



// Require all Ad placement configurations

var AdTech = function(selector) {

  // Select all ads on the page
  var ads = document.querySelectorAll(selector);

  if (typeof ADTECH !== 'undefined') {
    accountConfig.siteid = articleSiteId;

    // Configure our account
    ADTECH.config.page = accountConfig;

    setupAdPlacements(demoSiteConfig);


    // Loop them and enqueue
    [].forEach.call(ads, function(ad) {
      ADTECH.enqueueAd(ad.getAttribute('id'));
    });

    // Execute
    ADTECH.executeQueue({
      multiAd: {
        disableAdInjection: true
      }
    });

  } else {

    // Remove all our ad slots
    [].forEach.call(ads, function(ad) {
      ad.parentNode.removeChild(ad);
    });

  }

};

module.exports = AdTech;
