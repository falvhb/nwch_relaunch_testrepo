var _ = require('lodash');
var getViewportWidth = require('helpers/get-viewport-width');

var stickyParams = {}, scrollEvent, stickyNodesCount = 0;

var stickyScrollEvent = function() {
  var scrollY = window.scrollY || window.pageYOffset;
  scrollBehaviour(scrollY);
};

var toggleStickyScrolling = function() {
  scrollEvent = _.throttle(stickyScrollEvent, 10);
  if (getViewportWidth() > stickyParams.breakpoint) {
    // calculate dimensions
    var headerHeight = document.querySelector('.header-nav').offsetHeight;
    var stickyOffset = stickyParams.offset + headerHeight;
    var elHeightDifference = stickyParams.element.offsetHeight - stickyParams.stopper.offsetHeight;
    // store these for later
    stickyParams.startStick = stickyParams.element.offsetTop - stickyOffset;
    stickyParams.stopStick = stickyParams.stopper.offsetTop + (elHeightDifference - stickyOffset);
    stickyParams.stickyOffset = stickyOffset;
    // add event and trigger
    window.addEventListener('scroll', scrollEvent);
    stickyScrollEvent();
  } else {
    window.removeEventListener('scroll', scrollEvent);
  }
};

var fixedPosition = function(y) {
  stickyParams.wrapper.style.position = y ? 'fixed' :  'static';
  stickyParams.wrapper.style.top = y ? y + 'px' : 'auto';
};

var scrollBehaviour = function(current) {
  var stickPosition = 0;

  if (current >= stickyParams.startStick && current <= stickyParams.stopStick) {
    stickPosition = stickyParams.stickyOffset;
  }

  if (current > stickyParams.stopStick) {
    stickPosition = stickyParams.stickyOffset - (current - stickyParams.stopStick);
  }

  fixedPosition(stickPosition);
};

var createStickyWrapper = function(el, i) {
  var org_html = el.innerHTML;
  var new_html = '<div id="stickyNode--' + i + '">' + org_html + '</div>';
  el.innerHTML = new_html;
};

var StickyNodes = {

  init: function(params) {
    var element = document.querySelector(params.element);
    if (element) {
      // wrap the element so we can always get offsetTop value from the parent
      createStickyWrapper(element, stickyNodesCount);
      // form stick params
      stickyParams = {
        element: element,
        wrapper: document.getElementById('stickyNode--' + stickyNodesCount),
        stopper: document.querySelector(params.stopper) || document.querySelector('.footer'),
        offset: params.offset,
        breakpoint: params.breakpoint
      };
      // set events and init
      var debounced = _.debounce(toggleStickyScrolling, 200);
      window.addEventListener('resize', debounced, false);
      toggleStickyScrolling();
      stickyNodesCount++;
    }
  },

};

module.exports = StickyNodes;
