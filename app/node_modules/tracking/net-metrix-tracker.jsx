/* eslint-disable no-console */
import _ from 'lodash';
// import 'console-polyfill';
import deepForEach from 'helpers/deep-foreach';
import QS from 'qs';

const TYPE_PAGEVIEW = 'Pageview';
const TYPE_EVENT = 'Event';

/**
 * @ignore
 */
export default class NetMetrixTracker {

  static _removeEmptyMembers(data) {
    let clone,
        emptied;

    if (typeof data === 'undefined' || !data) {
      return {};
    }

    clone = _.cloneDeep(data);

    // set elements to undefined it they are null, an empty string or unedefined
    emptied = deepForEach(clone, function(e, key, obj) {
      if (e === null || e === '' || typeof(e) === 'undefined' ) {
        delete obj[key];
      }
    });

    return emptied;
  }

  static _getOrderedPath(data) {
    if (!data || typeof data === 'undefined' || typeof data.path !== 'object') {
      return [];
    }

    let path = [
      _.get(data, 'path.product'),
      _.get(data, 'path.sitename'),
      // limit to 1 folder as net metrix to meet the 5000 sections limit
      NetMetrixTracker._getFirstFolder(_.get(data, 'path.path')),
      _.get(data, 'path.view'),
      _.get(data, 'path.event')/*,
      _.get(data, 'path.id'),
      _.get(data, 'path.paging')*/
    ];

    return _.remove(path, _.isNotUndefined);
  }

  static _getFirstFolder(path) {
    if (typeof path === 'string') {
      let firstFolder = /^([^\/]*)/;
      let matches = firstFolder.exec(path);

      return matches[1];
    }

    return '';
  }

  static _sanitizePath(path) {
    if (typeof path === 'string') {
      return path.replace(/^[\/]*/, '').replace(/[\/]*$/, '');
    }

    return '';
  }

  static _buildPath(data) {
    let path = '';

    if (data instanceof Array && data.length && data.length > 0) {
      path = data.join('/').toLowerCase();
    }

    return path;
  }

  static _buildQS(data) {
    let saneData = data;
    if (!(saneData instanceof Object)) {
      saneData = {};
    }

    let params = {
      r: (typeof saneData.referer === 'string' ? `${encodeURIComponent(saneData.referer)}&` : ``),
      d: (Math.random() * 100000),
      x: ((typeof saneData.screenWidth === 'number' && typeof saneData.screenHeight ===  'number') ? `${saneData.screenWidth}x${saneData.screenHeight}` : ``)
    };

    return QS.stringify(params);
  }

  static _buildTag(data, path) {
    let saneData = data;
    let sanePath = path;
    let queryString = this._buildQS(data);

    if (!(saneData instanceof Object)) {
      saneData = {};
    }

    if (typeof saneData.domain !== 'string') {
      saneData.domain = 'aznetz';
    }

    if (typeof path !== 'string') {
      sanePath = '';
    }

    return `https://${saneData.domain}.wemfbox.ch/cgi-bin/ivw/CP/${sanePath}?${queryString}`;
  }

  static getTag(data) {
    let path,
        cleaned,
        saneData;

    // make sure basic object structure is in place
    saneData = _.extend({}, data);
    saneData.path = _.extend({}, saneData.path);
    saneData.path.path = saneData.path.path || '';

    // remove empty properties from data.path
    cleaned = this._removeEmptyMembers(saneData);

    // remove slashes from  data.path.path at start and end
    cleaned.path.path = this._sanitizePath(saneData.path.path);

    // order path properties
    cleaned.path = this._getOrderedPath(cleaned);

    //  get path as string
    path = this._buildPath(cleaned.path);

    return this._buildTag(cleaned, path);
  }

  static _requestTag(tag) {
    let image = document.createElement('img');
    image.src = tag;
    image.id = 'netMetrixPageViewTracker';
    image.width = 0;
    image.height = 0;

    // append element to dom so that we can more easily test it
    let oldImage = document.getElementById('netMetrixPageViewTracker');
    if (oldImage) {
      oldImage.parentNode.removeChild(oldImage);
    }
    document.getElementsByTagName('body')[0].appendChild(image);

    return image;
  }

  static _log(tag, type) {
    console.info(`Detected Net Metrix tag of type '${type}' not fired as current host "${window.location.host}" is not whitelisted as live host using the flag "without_wemf" in domain configuration of the cms. Net Metrix tag is: `, tag);
  }

  static isLiveHost() {
    // in case we do not get the configuration for `without_wemf` make sure we track anyway.
    let isLive = (typeof window.az !== 'undefined' ? !window.az.globals.without_wemf : true);
    return isLive;
  }

  static _track(data, type) {
    let tag = this.getTag(data);

    // Only request tag if we are live. Otherwise _log to console
    if (this.isLiveHost()) {
      this._requestTag(tag);
    } else {
      this._log(tag, type);
    }
  }

  static trackEvent(data) {
    this._track(data, NetMetrixTracker.TYPE_EVENT);
  }

  static trackPageView(data) {
    this._track(data, NetMetrixTracker.TYPE_PAGEVIEW);
  }

}

NetMetrixTracker.TYPE_PAGEVIEW = TYPE_PAGEVIEW;
NetMetrixTracker.TYPE_EVENT = TYPE_EVENT;
