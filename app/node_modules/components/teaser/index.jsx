import React from 'react';
import bem from 'react-bem-helper';
import _ from 'lodash';

import ResponsiveImage from 'components/responsive-image';
import TeaserTitle from 'components/teaser-title';
import TeaserByline from 'components/teaser-byline';
import TeaserMarker from 'components/teaser-marker';
import Schema from 'components/schema';

import { getViewportWidth } from 'helpers';
import { getTeaserResponsiveState } from 'helpers/teaser';

const classes = new bem({
  name: 'teaser',
  prefix: ''
});

export default React.createClass({

  displayName: 'Teaser',

  responsiveTeasers: [
    'basic-listed',
    'summary-listed'
  ],

  isResponsiveTeaser(_variation) {
    let variation = _variation || this.props.variation;
    return _.includes(this.responsiveTeasers, variation);
  },

  breakpoint: 500,

  resizeEvent: null,

  propTypes: {
    variation: React.PropTypes.string.isRequired,
    theme: React.PropTypes.object.isRequired,
    title: React.PropTypes.object.isRequired,
    link: React.PropTypes.string.isRequired,
    catchword: React.PropTypes.string,
    summary: React.PropTypes.string,
    byline: React.PropTypes.object,
    image: React.PropTypes.object,
    marker: React.PropTypes.object,
    schema: React.PropTypes.object
  },

  getInitialState() {
    return {
      view: 'desktop'
    };
  },

  getDefaultProps() {
    return {
      variation: 'basic',
      theme: {
        modifiers: ['theme-article']
      },
      schema: {}
    };
  },

  handleResize() {
    this.setState({
      view: getViewportWidth() <= this.breakpoint
        ? 'mobile'
        : 'desktop'
    });
  },

  componentDidMount() {
    // for teasers with two views e.g. `basic-listed`, `summary-listed`
    if (this.isResponsiveTeaser()) {
      this.handleResize();
      this.resizeEvent = _.debounce(this.handleResize, 250);
      window.addEventListener('resize', this.resizeEvent);
    }
  },

  componentWillUnmount() {
    if (this.isResponsiveTeaser()) {
      window.removeEventListener('resize', this.resizeEvent);
    }
  },

  componentDidUpdate(prevProps, prevState) {
    let { view } = this.state;
    // if the view changes
    if (prevState.view !== view) {
      // update the teaser config for this view
      let state = getTeaserResponsiveState(this.props, this.state);
      this.setState(state);
    }
  },

  render() {

    // stash our actual teaser variation
    const { variation } = this.props;

    // for changing modifier class
    let variationModifier;

    // get all our static props
    let { theme, title, link, catchword, summary, byline, image, marker, schema } = this.props;

    // if responsive teaser, get responsive props
    if (this.isResponsiveTeaser(variation)) {
      let newProps = getTeaserResponsiveState(this.props, this.state);
      variationModifier = newProps.variation;
      image = newProps.image;
      byline = newProps.byline;
      summary = newProps.summary;
    } else {
      variationModifier = variation;
    }

    // merge teaser modifier with theme modifiers
    let modifierClasses = [variationModifier].concat(theme.modifiers);

    return (
      <article {...classes(null, modifierClasses)} itemScope itemType='http://schema.org/Article'>
        <a {...classes('link')} href={link} itemProp='url'>
          {image
            ? <div {...classes('image')} itemProp='image' itemScope itemType='http://schema.org/ImageObject'>
                <TeaserMarker
                  {...marker}
                  modifiers={modifierClasses}
                />
                <ResponsiveImage
                  {...image}
                  fill={true}
                  fitToBox={true}
                />
              </div>
          :null}

          <footer {...classes('footer')}>
            {catchword
              ? <p {...classes('catchword')}>{catchword}</p>
            :null}

            <TeaserTitle {...title} modifiers={modifierClasses} />

            <Schema items={schema} />

            <TeaserByline {...byline} modifiers={modifierClasses} />

            {summary
              ? <p {...classes('summary')}>{summary}</p>
            :null}
          </footer>
        </a>
      </article>

    );
  }

});
