import React from 'react';
import _ from 'lodash';
import bem from 'react-bem-helper';

import ResponsiveImageMixin from 'mixins/responsive-image';

const classes = new bem({
  name: 'responsive-image',
  prefix: ''
});

export default React.createClass({

  mixins: [ResponsiveImageMixin],

  propTypes: {
    src: React.PropTypes.string.isRequired,
    alt: React.PropTypes.string.isRequired,
    size: React.PropTypes.string.isRequired,
    ratio: React.PropTypes.string,
    title: React.PropTypes.string,
    defer: React.PropTypes.bool,
    fill: React.PropTypes.bool
  },

  getDefaultProps() {
    return {
      ratio: '16x9',
      title: ''
    };
  },

  getInitialState() {
    return {
      loading: true
    };
  },

  componentDidMount() {
    window.addEventListener('resize', _.debounce(this.handleResize, 250));
    this.setState({
      support: true,
      src: this.responsiveImageSrc({
        src: this.props.src,
        size: this.props.size,
        ratio: this.props.ratio,
        fill: this.props.fill
      })
    });
  },

  componentWillUnmount() {
    window.removeEventListener('resize', this.handleResize);
  },

  componentDidUpdate() {
    if (this.props.defer && !this.state.src) {
      this.lazyLoadSrc();
    } else if (this.state.loading) {
      this.testLoaded();
    }
  },

  render() {

    var props = this.props;

    var loadingClass = {
      'is-loading': this.state.loading && this.state.support
    };

    var image;
    var imgSrc = this.responsiveImageSrc({
      src: props.src,
      size: props.size,
      ratio: props.ratio,
      fill: props.fill
    });
    var imageProps = {
      alt: props.alt,
      title: props.title
    };

    var imageEl = <img itemProp="contentUrl" ref='img' {...classes('img')} src={imgSrc} {...imageProps} />;

    if (props.defer) {
      var deferEl = <img itemProp="contentUrl" ref='img' {...classes('img')} src={this.state.src} data-src={imgSrc} {...imageProps} />;
    }

    if (this.state.support) {
      image = (
        <div {...classes('', [props.ratio, props.size], loadingClass)}>
          {props.defer ? deferEl : imageEl}
        </div>
      );
    } else {
      image = (
        <noscript dangerouslySetInnerHTML={{ __html: React.renderToStaticMarkup(
          <picture {...classes('', [props.ratio, props.size, 'fallback'])} alt={props.alt}>
            <source itemProp="contentUrl" {...classes('img')} srcSet={this.responsiveImageSrc({ src: props.src, size: 'max', ratio: props.ratio })} media="(min-width:640px)" />
            <source itemProp="contentUrl" {...classes('img')} srcSet={this.responsiveImageSrc({ src: props.src, size: 'large', ratio: props.ratio })} media="(min-width:500px)" />
            <source itemProp="contentUrl" {...classes('img')} srcSet={this.responsiveImageSrc({ src: props.src, size: 'medium', ratio: props.ratio })} media="(min-width:320px)" />
            <source itemProp="contentUrl" {...classes('img')} srcSet={this.responsiveImageSrc({ src: props.src, size: 'small', ratio: props.ratio })} />
            {imageEl}
          </picture>
        )}} />
      );
    }

    return image;
  }

});
