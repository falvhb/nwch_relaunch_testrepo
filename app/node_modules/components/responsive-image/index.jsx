import React from 'react';
import _ from 'lodash';
import bem from 'react-bem-helper';

import ResponsiveImageMixin from 'mixins/responsive-image';

const classes = new bem({
  name: 'responsive-image',
  prefix: ''
});

export default React.createClass({

  displayName: 'ResponsiveImage',

  mixins: [ResponsiveImageMixin],

  propTypes: {
    src: React.PropTypes.string.isRequired,
    title: React.PropTypes.string,
    alt: React.PropTypes.string,
    size: React.PropTypes.string.isRequired,
    ratio: React.PropTypes.string,
    defer: React.PropTypes.bool,
    fill: React.PropTypes.bool
  },

  getDefaultProps() {
    return {
      ratio: '16x9',
      title: ''
    };
  },

  getInitialState() {
    return {
      loading: true,
      failed: false
    };
  },

  componentDidMount() {
    window.addEventListener('resize', _.debounce(this.handleResize, 250));
    this.setState({
      support: true,
      src: this.responsiveImageSrc(this.props)
    });
  },

  componentWillUnmount() {
    window.removeEventListener('resize', this.handleResize);
  },

  componentDidUpdate() {
    if (this.props.defer && !this.state.src) {
      this.lazyLoadSrc();
    } else if (this.state.loading) {
      this.testLoaded();
    }
  },

  render() {

    var { src, title, alt, size, ratio, defer } = this.props;

    var { support, loading, failed } = this.state;

    var loadingClass = {
      'is-loading': loading && support,
      'is-failed': failed
    };

    var imageEl =
      <img
        {...classes('img')}
        itemProp="contentUrl"
        ref='img'
        src={(defer ? this.state.src : this.responsiveImageSrc(this.props))}
        data-src={(defer ? this.responsiveImageSrc(this.props) : null)}
        title={title}
        alt={alt} />;

    if (support) {
      return (
        <div {...classes('', [ratio, size], loadingClass)}>
          {imageEl}
        </div>
      );
    }

    return (
      <noscript dangerouslySetInnerHTML={{ __html: React.renderToStaticMarkup(
        <picture {...classes('', [ratio, size, 'fallback'])} alt={alt}>
          <source itemProp="contentUrl" {...classes('img')} srcSet={this.responsiveImageSrc({ src: src, size: 'max', ratio: ratio })} media="(min-width:640px)" />
          <source itemProp="contentUrl" {...classes('img')} srcSet={this.responsiveImageSrc({ src: src, size: 'large', ratio: ratio })} media="(min-width:500px)" />
          <source itemProp="contentUrl" {...classes('img')} srcSet={this.responsiveImageSrc({ src: src, size: 'medium', ratio: ratio })} media="(min-width:320px)" />
          <source itemProp="contentUrl" {...classes('img')} srcSet={this.responsiveImageSrc({ src: src, size: 'small', ratio: ratio })} />
          {imageEl}
        </picture>
      )}} />
    );
  }

});
