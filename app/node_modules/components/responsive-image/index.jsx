'use strict';

const React = require('react');
const bem = require('react-bem-helper');

const ResponsiveImageMixin = require('mixins/responsive-image');

const classes = new bem({
  name: 'responsive-image',
  prefix: ''
});

const ResponsiveImage = React.createClass({

  mixins: [ResponsiveImageMixin],

  propTypes: {
    size: React.PropTypes.string.isRequired,
    src: React.PropTypes.string.isRequired,
    alt: React.PropTypes.string.isRequired,
    ratio: React.PropTypes.string,
    title: React.PropTypes.string,
    defer: React.PropTypes.bool
  },

  getDefaultProps() {
    return {
      ratio: '3x2',
      title: '',
      defer: false,
    };
  },

  getInitialState() {
    return {
      support: false,
      loading: true,
      lazySrc: false
    };
  },

  componentDidMount() {
    this.setState({ support: true });
  },

  componentDidUpdate() {
    if (this.props.defer && !this.state.lazySrc) {
      this.lazyLoadSrc();
    } else {
      this.testLoaded();
    }
  },

  render() {

    var props = this.props;

    var loadingClass = {
      'is-loading': this.state.loading
    };

    var image;
    var imageSrc = this.responsiveImageSrc(props.src, props.size, props.ratio);
    var imageProps = {
      alt: props.alt,
      title: props.title
    };

    var imageEl = <img ref='img' {...classes('img')} src={imageSrc} {...imageProps} />;

    if (props.defer) {
      var deferEl = <img ref='img' {...classes('img')} src={this.state.lazySrc} data-src={imageSrc} {...imageProps} />;
    }

    if (this.state.support) {
      image = (
        <div {...classes('', [props.ratio, props.size], loadingClass)}>
          {props.defer ? deferEl : imageEl}
        </div>
      );
    } else {
      image = (
        <noscript dangerouslySetInnerHTML={{ __html: React.renderToStaticMarkup(
          <picture {...classes('', [props.ratio, props.size, 'fallback'])} alt={props.alt}>
            <source {...classes('img')} srcSet={this.responsiveImageSrc(props.src, 'huge', props.ratio)} media="(min-width:960px)" />
            <source {...classes('img')} srcSet={this.responsiveImageSrc(props.src, 'large', props.ratio)} media="(min-width:640px)" />
            <source {...classes('img')} srcSet={this.responsiveImageSrc(props.src, 'medium', props.ratio)} media="(min-width:320px)" />
            <source {...classes('img')} srcSet={this.responsiveImageSrc(props.src, 'small', props.ratio)} />
            {imageEl}
          </picture>
        )}} />
      );
    }

    return image;
  }

});

module.exports = ResponsiveImage;
