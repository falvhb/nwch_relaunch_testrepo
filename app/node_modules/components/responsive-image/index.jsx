import React from 'react';
import _ from 'lodash';
import bem from 'react-bem-helper';

import ResponsiveImageMixin from 'mixins/responsive-image';

const classes = new bem({
  name: 'responsive-image',
  prefix: ''
});

export default React.createClass({

  displayName: 'ResponsiveImage',

  mixins: [ResponsiveImageMixin],

  propTypes: {
    src: React.PropTypes.string.isRequired,
    title: React.PropTypes.string,
    alt: React.PropTypes.string,
    size: React.PropTypes.string.isRequired,
    ratio: React.PropTypes.string,
    defer: React.PropTypes.bool,
    letterbox: React.PropTypes.bool,
    lazyload: React.PropTypes.bool
  },

  getDefaultProps() {
    return {
      ratio: '16x9',
      title: '',
      letterbox: false
    };
  },

  getInitialState() {
    return {
      loading: true,
      failed: false
    };
  },

  componentDidMount() {
    window.addEventListener('resize', _.debounce(this.handleResize, 250));
    this.setState({
      support: true,
      src: this.responsiveImageSrc(this.props),
    });
  },

  componentWillUnmount() {
    window.removeEventListener('resize', this.handleResize);
  },

  componentWillReceiveProps(newProps) {
    // reset src if we dynamically update image props
    // this makes lazy-loading work again
    if (newProps.src !== this.props.src) {
      this.setState({ src: false });
    }
  },

  componentDidUpdate() {
    if (this.props.defer && !this.state.src) {
      this.lazyLoadSrc();
    } else if (this.state.loading) {
      this.testLoaded();
    }
  },

  render() {

    var { src, title, alt, size, ratio, defer, letterbox, lazyload } = this.props;

    var { support, loading, failed } = this.state;

    var modifiers = {
      [ratio]: true,
      [size]: true,
      letterbox: letterbox,
      fill: !letterbox,
      fallback: !support
    };

    var loadingClass = {
      'is-loading': loading && support && !lazyload,
      'is-failed': failed,
      'is-loaded': !loading && support || !support
    };

    var img;

    if (support) {
      img = (
        lazyload
          ? <img {...classes('img')} itemProp="contentUrl" ref='img' data-flickity-lazyload={this.state.src} title={title} alt={alt} />
          : <img {...classes('img')} itemProp="contentUrl" ref='img' src={(defer ? this.state.src : this.responsiveImageSrc(this.props))} data-src={(defer ? this.responsiveImageSrc(this.props) : null)} title={title} alt={alt} />
      );
    } else {
      img = (
        <noscript dangerouslySetInnerHTML={{ __html: React.renderToStaticMarkup(
          <picture>
            <source itemProp="contentUrl" {...classes('img')} srcSet={this.responsiveImageSrc({ src: src, size: 'max', ratio: ratio, letterbox: letterbox })} media="(min-width:640px)" />
            <source itemProp="contentUrl" {...classes('img')} srcSet={this.responsiveImageSrc({ src: src, size: 'medium', ratio: ratio, letterbox: letterbox })} media="(min-width:320px)" />
            <source itemProp="contentUrl" {...classes('img')} srcSet={this.responsiveImageSrc({ src: src, size: 'small', ratio: ratio, letterbox: letterbox })} />
            <img {...classes('img')} itemProp="contentUrl" ref='img' src={this.responsiveImageSrc(this.props)} title={title} alt={alt} />
          </picture>
        )}} />
      );
    }

    return (
      <div {...classes(null, modifiers, loadingClass)}>
        {img}
      </div>
    );
  }

});
