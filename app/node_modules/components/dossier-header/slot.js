var _ = require('lodash');
var getPrimaryDossierData = require('helpers/dossier/get-primary-data');

var lowerCaseArray = function(array) {
  if (array.length) {
    return array.map(function(str) { return str.toLowerCase(); });
  }
  return array;
};

var collateKeywords = function(dossier, keywords) {
  var all = _.merge(lowerCaseArray(keywords), lowerCaseArray(dossier.keywords));
  var uniq = _.uniq(all);
  return _.remove(uniq, function(n) {
    return n !== dossier.title;
  }).slice(0, 6);
};

var dossierText = function(header) {
  return header.text || '<p>' + header.title + '</p>';
};

var parsedDossier = function(dossier, keywords) {
  var header = dossier.header;
  var primaryProps = getPrimaryDossierData(dossier);

  var headerProps = {
    text: dossierText(header),
    tags: collateKeywords(dossier, keywords)
  };

  return _.assign({}, primaryProps, headerProps);
};

var parsedData = function(state) {
  return parsedDossier(state.dossier, state.keywords);
};

module.exports = {
  iso: true,
  data: parsedData
};
