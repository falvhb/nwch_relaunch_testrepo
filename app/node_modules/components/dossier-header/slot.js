var _ = require('lodash');
var helpers = require('helpers');

module.exports = function(state) {

  var collateKeywords = function(dossier, keywords) {
    var all = _.merge(dossier.keywords, keywords);
    var uniq = _.uniq(all);
    return _.remove(uniq, function(n) {
      return n !== dossier.title;
    });
  };

  var parsedData = function(dossier, keywords) {
    var header = dossier.header;
    var mainAsset = helpers.getImageProps(_.first(header.assets));
    return {
      title: dossier.title,
      text: header.text,
      background: mainAsset ? mainAsset.src : null,
      image: mainAsset,
      tags: collateKeywords(dossier, keywords)
    };
  };

  return parsedData(state.dossier, state.keywords);

};
