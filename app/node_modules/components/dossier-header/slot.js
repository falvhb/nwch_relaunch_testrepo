var _ = require('lodash');
var helpers = require('helpers');

module.exports = function(state) {

  var getBackgroundImage = function(assets) {
    var asset = assets.length > 1
      ? _.slice(assets, 1, 1)
      : _.first(assets);

    return helpers.getImageProps(asset).src;
  };

  var getMainImage = function(assets) {
    return helpers.getImageProps(_.first(assets));
  };

  var collateKeywords = function(dossier, keywords) {
    var all = _.merge(dossier.keywords, keywords);
    var uniq = _.uniq(all);
    return _.remove(uniq, function(n) {
      return n !== dossier.title;
    });
  };

  var parsedData = function(dossier, keywords) {
    var header = dossier.header;
    return {
      title: dossier.title,
      subtitle: header.title,
      text: header.text,
      background: getBackgroundImage(header.assets),
      image: getMainImage(header.assets),
      tags: collateKeywords(dossier, keywords)
    };
  };

  return parsedData(state.dossier, state.keywords);

};
