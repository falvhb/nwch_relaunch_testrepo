/*global Flickity:true*/
import React from 'react';
import bem from 'react-bem-helper';
import _ from 'lodash';

import Container from 'components/container';

const classes = new bem({
  name: 'related-videos',
  prefix: ''
});

export default React.createClass({

  // Breakpoint under which Flickity should be initialized
  breakpoint: 640,
  // Contains the instance of Flickity once initialized
  flickity: null,
  // The selector on which Flickity should be initialized
  flickityElement: '.recommendation',
  // The options with which Flickity should be initialized
  flickityOptions: {
    freeScroll: false,
    prevNextButtons: false,
    pageDots: false
  },

  getInitialState() {
    return {
      // No JS / server.js
      support: false,
      // Initial state is not mobile
      mobile: false
    };
  },

  // Return the viewport width
  getViewportWidth() {
    return Math.max(document.documentElement.clientWidth, window.innerWidth);
  },

  // Method called when the window gets resized; redefines the `mobile` state
  handleResize() {
    this.setState({
      mobile: this.getViewportWidth() <= this.breakpoint
    });
  },

  componentDidMount() {
    window.addEventListener('resize', _.debounce(this.handleResize, 250));

    // Redefine the `mobile` state
    this.handleResize();

    // Redefine the `support` state
    this.setState({
      support: true
    });

    if (this.state.mobile && this.state.support) {
      this.initSlider();
    }
  },

  componentWillUnmount() {
    window.removeEventListener('resize', this.handleResize);
    this.destroySlider();
  },

  // Initialize Flickity
  initSlider() {
    // Break in case Flickity is not loaded for some reason
    if (typeof Flickity === 'undefined') {
      return false;
    }

    this.flickity = new Flickity(this.flickityElement, this.flickityOptions);
  },

  // Remove Flickity
  destroySlider() {
    if (typeof this.flickity.destroy === 'function') {
      this.flickity.destroy();
    }
  },

  componentDidUpdate() {
    if (this.state.mobile && this.state.support) {
      this.initSlider();
    } else if (this.flickity !== null) {
      this.destroySlider();
    }
  },

  render() {

    return (
      <section {...classes()}>
        <Container>
          <h3 {...classes('title')}>Verwandte Videos</h3>
          <div className="veeseoRA2VW2"></div>
          <script src="http://rce.veeseo.com/widgets/aargauerzeitung/widget.js" async></script>
        </Container>
      </section>
    );
  }
});
