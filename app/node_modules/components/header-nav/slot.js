var _ = require('lodash');
var DomainVariations = require('config/domain-variations');
var NavItems = require('config/nav-items');

var mappedNavItems = function(state, items) {
  var skin = state.skin;
  var path = state.path;
  var activeSection = getActiveSection(path);
  if (skin in DomainVariations) {
    // Adds the home item to the nav
    items.splice(1, 0, {
      href: DomainVariations[skin].href,
      label: DomainVariations[skin].label
    });
  }

  return items.map(function(item) {
    if (activeSection === item.href) {
      return _.assign({ active: true }, item);
    }
    return item;
  });
};

var getActiveSection = function(path) {
  // path comes in the form /__component__/<section>/header-nav/default
  var segments = path.match(/\/(\w|-)+/g);
  var sections = _.without(segments, '/__component__', '/header-nav', '/default');
  return sections[0] || '/';
};

var parsedData = function(state) {
  var navItems = NavItems.slice();

  return {
    skin: state.skin,
    navigation: mappedNavItems(state, navItems)
  };
};

module.exports = {
  iso: true,
  data: parsedData
};
