'use strict';

const React = require('react');

const Video = React.createClass({

  componentWillMount: function() {
    console.log('componentWillMount',': ',this.props.title);
  }
  ,componentWillUpdate: function(nextProps, nextState) {
    //console.log('componentWillUpdate',': ', nextProps, nextState);
  }
  ,componentDidMount: function() {
    console.log('componentDidMount','id:',this.refs.videoContainer.props.id);

    var loadJQuery = function() {
      // load the script
      var script = document.createElement("SCRIPT");
      script.src = 'https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js';
      script.type = 'text/javascript';
      document.getElementsByTagName("head")[0].appendChild(script);

      // poll for jQuery to come into existance
      var checkReady = function(callback) {
        if (window.jQuery) {
          callback(jQuery);
        }
        else {
          window.setTimeout(function() { checkReady(callback); }, 100);
        }
      };

      // start polling...
      var props = this.props;
      checkReady(function($) {
        //console.log('PROPS2: ',props);

        //@TODO4: check kaltura library is only loaded once
        //Note: if you want to the component to be fully self containing one has to accept that the kaltura player library for one player can be loaded several times (e.g. as many times as a certain player occurs in a page)

        $.getScript( "http://cdnapi.kaltura.com/p/1719221/sp/171922100/embedIframeJs/uiconf_id/"+props.playerID+"/partner_id/1719221", function( data, textStatus, jqxhr ) {
          //console.log("Kaltura player js was loaded.");

          if (textStatus == "success") {
            var config = {
              'targetId': props.kalturaID,
              'wid': '_1719221',
              'uiconf_id': props.playerID,
              'entry_id': props.kalturaID,
              'flashvars': {
                'EmbedPlayer.EnableFullscreen': false
              }
            };
            kWidget.embed(config);
            console.log('Embedding Kaltura player',config);
          }

        });
      });

    };

    //load jQuery only if not already there
    if (typeof jQuery!=='undefined') {
      //@TODO3: BUG: Uncaught ReferenceError: checkReady is not defined
      checkReady();
    } else {
      loadJQuery.apply(this);
      //@TODO5: make sure loading of jQuery is not started more than once asynchronously
    }


  }

  ,render() {
    return (
      <div ref="videoContainer" id={this.props.kalturaID}>

      </div>
    );
  }

});

module.exports = Video;
