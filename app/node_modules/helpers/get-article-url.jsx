import slugify from 'slugify';
import _ from 'lodash';

/**
 * Generates the URL for an article
 *
 * @param  {object}  article  The API response containing article data
 *
 * @return  {string}  The URL for the article
 */
export function formCanonicalUrlPath(article, leadingSlash) {
  if (article && article.ressorts) {
    let ressorts = article.ressorts;
    let canonicalRessort = _.first(_.filter(ressorts, { 'ignore_for_canonical_url': false }));
    let mainRessort = canonicalRessort ? canonicalRessort : _.first(ressorts);

    // url format /<ressort>/<subressort>/<name>-<id>
    let paths = [];

    // <ressort>
    if (mainRessort && mainRessort.parent) {
      paths.push(mainRessort.parent.urlpart);
    }

    // <subressort>
    if (mainRessort && mainRessort.urlpart) {
      paths.push(mainRessort.urlpart);
    }

    // <name>
    let name;
    if (article.manual_url) {
      name = article.manual_url;
    } else if (article.keyword_url && article.keywords) {
      name = slugify(article.keywords);
    } else {
      name = slugify(article.title);
    }

    // + -<id>
    paths.push(name + '-' + article.id);

    let result = paths.join('/');
    if (leadingSlash) {
      return '/' + result;
    }
    return result;
  }
  return null;
}

export default function(article) {
  return formCanonicalUrlPath(article, true /*leadingSlash*/) || '#';
}
