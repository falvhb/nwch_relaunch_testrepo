<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">tracking/net-metrix-tracker.jsx | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/lovelysystems/az-nwch-js" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/tracking/tracker.jsx~Tracker.html">Tracker</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">tracking/net-metrix-tracker.jsx</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/* eslint-disable no-console */
import _ from &apos;lodash&apos;;
import deepForEach from &apos;helpers/deep-foreach&apos;;
import QS from &apos;qs&apos;;
import config from &apos;tracking/config.json&apos;;

const TYPE_PAGEVIEW = &apos;Pageview&apos;;
const TYPE_EVENT = &apos;Event&apos;;

/**
 * @ignore
 */
export default class NetMetrixTracker {

  static _removeEmpty(data) {
    let clone = _.cloneDeep(data);

    return deepForEach(clone, function(e, key, obj) {
      if (e === null || e === &apos;&apos; || typeof(e) === &apos;undefined&apos; ) {
        delete obj[key];
      }
    });
  }

  static _getOrderedPath(data) {
    let path = [
      data.path.product,
      data.path.sitename,
      data.path.view,
      data.path.path,
      data.path.event,
      data.path.id,
      data.path.index
    ];

    return _.remove(path, _.isNotUndefined);
  }

  static _sanitizePath(path) {
    if (typeof path === &apos;string&apos;) {
      return path.replace(/^[\/]*/, &apos;&apos;).replace(/[\/]*$/, &apos;&apos;);
    }

    return &apos;&apos;;
  }

  static _buildPath(data) {
    let path = &apos;&apos;;

    if (data.length &amp;&amp; data.length &gt; 0) {
      path = data.join(&apos;/&apos;);
    }

    return path;
  }

  static _buildQS(data) {
    let params = {
      r: (data.referer ? `${encodeURIComponent(data.referer)}&amp;` : ``),
      d: (Math.random() * 100000),
      x: ((data.screenWidth &amp;&amp; data.screenHeight) ? `${data.screenWidth}x${data.screenHeight}` : ``)
    };

    return QS.stringify(params);
  }

  static _buildTag(data, path) {
    let queryString = this._buildQS(data);

    return `https://${data.domain}.wemfbox.ch/cgi-bin/ivw/CP/${path}?${queryString}`;
  }

  static getTag(data) {
    let path,
        cleaned;

    // remove empty properties from data.path
    cleaned = this._removeEmpty(data);

    // remove slahes from  data.path.path at start and end
    cleaned.path.path = this._sanitizePath(data.path.path);

    // order path properties
    cleaned.path = this._getOrderedPath(cleaned);

    //  get path as string
    path = this._buildPath(cleaned.path);

    return this._buildTag(cleaned, path);
  }

  static _requestTag(tag) {
    let image = new Image();

    image.src = tag;
  }

  static _log(tag, type) {
    console.info(`Detected Net Metrix tag of type &apos;${type}&apos; not fired as current host &quot;${window.location.host}&quot; is not whitelisted as live host in &quot;app/node_modules/tracking/config.json&quot;. Net Metrix tag is: `, tag);
  }

  static isLiveHost(host) {
    let liveHosts = [];
    let isLive = false;

    // throw error if live hosts are not specified
    if (typeof this.config === &apos;undefined&apos; || !this.config || !this.config.netMetrix.liveHosts) {
      console.error(&apos;You must specify hosts enabled for _tracking under netMetrix.liveHosts[] in _tracking/config.json in order to _track Net Metrix Audit.&apos;);
    } else {
      liveHosts = this.config.netMetrix.liveHosts;
    }

    // check if we are on a live host
    _.forEach(liveHosts, function(e) {
      if (host.search(e) &gt; -1) {
        isLive = true;
      }
    });

    return isLive;
  }

  static _track(data, type) {
    let tag = this.getTag(data);

    // Only request tag if we are live. Otherwise _log to console
    if (window &amp;&amp; this.isLiveHost(window.location.host)) {
      this._requestTag(tag);
    } else {
      this._log(tag, type);
    }
  }

  static trackEvent(data) {
    this._track(data, NetMetrixTracker.TYPE_EVENT);
  }

  static trackPageView(data) {
    this._track(data, NetMetrixTracker.TYPE_PAGEVIEW);
  }

}

NetMetrixTracker.config = config;
NetMetrixTracker.TYPE_PAGEVIEW = TYPE_PAGEVIEW;
NetMetrixTracker.TYPE_EVENT = TYPE_EVENT;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.1)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
